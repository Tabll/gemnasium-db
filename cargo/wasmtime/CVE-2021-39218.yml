---
identifier: "CVE-2021-39218"
identifiers:
- "CVE-2021-39218"
- "GHSA-4873-36h9-wv49"
package_slug: "cargo/wasmtime"
title: "Out-of-bounds read/write and invalid free with `externref`s and GC safepoints
  in Wasmtime "
description: "There was an invalid free and out-of-bounds read and write bug when
  running Wasm that uses `externref`s in Wasmtime.\n\nTo trigger this bug, Wasmtime
  needs to be running Wasm that uses `externref`s, the host creates non-null `externrefs`,
  Wasmtime performs a garbage collection (GC), and there has to be a Wasm frame on
  the stack that is at a GC safepoint where\n\n* there are no live references at this
  safepoint, and\n* there is a safepoint with live references earlier in this frame's
  function.\n\nUnder this scenario, Wasmtime would incorrectly use the GC stack map
  for the safepoint from earlier in the function instead of the empty safepoint. This
  would result in Wasmtime treating arbitrary stack slots as `externref`s that needed
  to be rooted for GC. At the *next* GC, it would be determined that nothing was referencing
  these bogus `externref`s (because nothing could ever reference them, because they
  are not really `externref`s) and then Wasmtime would deallocate them and run `<ExternRef
  as Drop>::drop` on them. This results in a free of memory that is not necessarily
  on the heap (and shouldn't be freed at this moment even if it was), as well as potential
  out-of-bounds reads and writes.\n\nEven though support for `externref`s (via the
  reference types proposal) is enabled by default, unless you are creating non-null
  `externref`s in your host code or explicitly triggering GCs, you cannot be affected
  by this bug.\n\nWe have reason to believe that the effective impact of this bug
  is relatively small because usage of `externref` is currently quite rare."
date: "2021-09-17"
pubdate: "2021-09-20"
affected_range: ">=0.26.0 <0.30.0"
fixed_versions:
- "0.30.0"
affected_versions: "All versions starting from 0.26.0 before 0.30.0"
not_impacted: "All versions before 0.26.0, all versions starting from 0.30.0"
solution: "Upgrade to version 0.30.0 or above."
urls:
- "https://nvd.nist.gov/vuln/detail/CVE-2021-39218"
- "https://github.com/advisories/GHSA-4873-36h9-wv49"
- "https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-4873-36h9-wv49"
- "https://github.com/bytecodealliance/wasmtime/commit/398a73f0dd862dbe703212ebae8e34036a18c11c"
- "https://crates.io/crates/wasmtime"
- "https://github.com/bytecodealliance/wasmtime"
- "https://lists.fedoraproject.org/archives/list/package-announce@lists.fedoraproject.org/message/WAVBRYDDUIY2ZR3K3FO4BVYJKIMJ5TP7"
- "https://lists.fedoraproject.org/archives/list/package-announce@lists.fedoraproject.org/message/Z2Z33FTXFQ6EOINVEQIP4DFBG53G5XIY"
- "https://rustsec.org/advisories/RUSTSEC-2021-0110.html"
cvss_v3: "CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:H/A:H"
uuid: "5a38805d-9dff-4bfc-945b-d28ad40e0c8c"
cwe_ids:
- "CWE-125"
- "CWE-590"
- "CWE-787"
- "CWE-937"
- "CWE-1035"
