---
identifier: "CVE-2024-24752"
identifiers:
- "CVE-2024-24752"
- "GHSA-x4hh-frx8-98r5"
package_slug: "packagist/bref/bref"
title: "Bref's Uploaded Files Not Deleted in Event-Driven Functions"
description: "When Bref is used with the Event-Driven Function runtime and the handler
  is a `RequestHandlerInterface`, then the Lambda event is converted to a PSR7 object.\nDuring
  the conversion process, if the request is a MultiPart, each part is parsed and for
  each which contains a file, it is extracted and saved in `/tmp` with a random filename
  starting with `bref_upload_`.\n\nThe function implementing the logic follows:\n\n```php\nprivate
  static function parseBodyAndUploadedFiles(HttpRequestEvent $event): array\n{\n$bodyString
  = $event->getBody();\n$files = [];\n$parsedBody = null;\n$contentType = $event->getContentType();\nif
  ($contentType !== null && $event->getMethod() === 'POST') {\nif (str_starts_with($contentType,
  'application/x-www-form-urlencoded')) {\nparse_str($bodyString, $parsedBody);\n}
  else {\n$document = new Part(\"Content-type: $contentType\\r\\n\\r\\n\" . $bodyString);\nif
  ($document->isMultiPart()) {\n$parsedBody = [];\nforeach ($document->getParts()
  as $part) {\nif ($part->isFile()) {\n$tmpPath = tempnam(sys_get_temp_dir(), 'bref_upload_');\nif
  ($tmpPath === false) {\nthrow new RuntimeException('Unable to create a temporary
  directory');\n}\nfile_put_contents($tmpPath, $part->getBody());\n$file = new UploadedFile($tmpPath,
  filesize($tmpPath), UPLOAD_ERR_OK, $part->getFileName(), $part->getMimeType());\n\nself::parseKeyAndInsertValueInArray($files,
  $part->getName(), $file);\n} else {\nself::parseKeyAndInsertValueInArray($parsedBody,
  $part->getName(), $part->getBody());\n}\n}\n}\n}\n}\nreturn [$files, $parsedBody];\n}\n```\n\nThe
  flow mimics what plain PHP does but it does not delete the temporary files when
  the request has been processed."
date: "2024-10-17"
pubdate: "2024-02-01"
affected_range: "<2.1.13"
fixed_versions:
- "2.1.13"
affected_versions: "All versions before 2.1.13"
not_impacted: "All versions starting from 2.1.13"
solution: "Upgrade to version 2.1.13 or above."
urls:
- "https://nvd.nist.gov/vuln/detail/CVE-2024-24752"
- "https://github.com/advisories/GHSA-x4hh-frx8-98r5"
- "https://github.com/brefphp/bref/security/advisories/GHSA-x4hh-frx8-98r5"
- "https://github.com/brefphp/bref/commit/350788de12880b6fd64c4c318ba995388bec840e"
- "https://github.com/brefphp/bref"
- "https://github.com/brefphp/bref/blob/2.1.12/src/Event/Http/Psr7Bridge.php#L94-L125"
cvss_v3: "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H"
uuid: "bb6bb521-3ce2-47c3-837b-305a5b98bf37"
cwe_ids:
- "CWE-400"
- "CWE-770"
- "CWE-937"
- "CWE-1035"
